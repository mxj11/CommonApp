TCP点对点穿透探索--失败 - Toonter - 博客园
http://www.cnblogs.com/Toonter/p/5982799.html

穿透技术：
    NAT（Network Address Translation）网络地址转换：NAT的主要用途，大家可以看路由器。路由器具有一个WAN口及多个LAN口；
WAN口对外，连接因特网，拥有公网IP；LAN口对内，构建本地网络，分配的是私网IP。当处于LAN网下的本地主机想要访问因特网的时
候，路由器就会通过NAT技术，将LAN 口的私网IP映射到WAN口的公网IP，实现网络地址的转换，这样本地主机就可以访问因特网了。

    举个例子，假如路由器WAN口获取到的公网IP是55.66.77.88（随便写的），LAN网下某台本地主机获取到的私网IP是192.168.0.100
（路由器多是192.168.0.0网段）。现在本地主机想要向英特网发起连接，它通过自己的10000端口发起了连接，路由器知道有本地
主机向英特网发起连接，便会分配一个WAN口的可用端口做映射，比如分配到的是5000端口。这时，192.168.0.100的10000端口便和
55.66.77.88的5000端口产生了映射关系。55.66.77.88的5000端口收到的网络包便会转发到192.168.0.100的10000端口,192.
168.0.100的10000端口收到的网络包也会转发到55.66.77.88的5000端口。当然，由于是网络地址转换，这途中还会有拆包，重新装
包的过程。
    按照上面的描述，NAT的工作需要LAN网下的本地设备主动发起网络连接，然后NAT服务才会将这个连接映射到WAN口的公网IP完成转换。
也就是说，如果本地主机没有主动发起连接，那么这个映射就不会存在，那么公网上的机器就无法访问到私网上的机器。也就是说，
只能是私网机器主动连接公网机器，而不能是公网机器主动连接私网机器。而为了实现公网机器主动连接私网机器，我们就需要穿透NAT，
这就是NAT穿透的由来。
    目前比较好实现NAT穿透的方式是采用UDP连接对NAT进行打洞，然后完成连接。何为打洞呢？就是为了使NAT产生一个可用的映射。具
体步骤就是在私网机器上用UDP向某台公网机器发起连接，使得NAT产生一个可以使用的映射（洞）。然后通过这个映射（洞），就可以
穿透NAT。
    至于为什么要用UDP，这是由于UDP的某些特性。UDP通信需要先绑定本地机器的端口，完成后就可以从这个端口收发数据，至于从哪里
收，发到哪里，可以在收发数据的时候再决定，这也就意味着我可以用这一个端口同时和多个对象通信，只要我收发数据的时候指定不
同的对象即可。当本地机器用UDP向英特网上的某个服务器发送数据的时候，这个映射不但能用来和这个服务器进行数据交互，也能用
来接收其他主机发来的数据。NAT穿透就是本地主机向公网上的某台服务器发送数据，这时服务器就可以获得NAT对这台主机的映射，
在之前举得例子中就是55.66.77.88:5000这个地址。由于NAT会将55.66.77.88:5000收到的数据转发至本地主机，所以公网上的
其他机器可以从服务器获取到55.66.77.88:5000这个网络地址，然后通过这个网络地址向私网下的机器发出数据。
而至于为什么不用TCP，也是由于TCP的某些特性。TCP通信的步骤与UDP不同，它需要先在两个对象之间建立一个专用通道，再用这个
通道收发数据。也就是说外人无法插手。这样一来，虽然其他机器可以通过服务器获取到NAT的映射对象，也没办法利用它向私网下的
机器发出数据。